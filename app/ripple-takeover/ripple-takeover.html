<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="ripple-takeover"
                 attributes="cardTitle photo rippleColor">
  <template>
    <link rel="stylesheet" href="ripple-takeover.css">

    <template if="{{!expanded}}">
      <div>
        <content select=".pre-takeover"></content>
      </div>
    </template>

    <div class="card-info" id="cardContainer">
      <div class="{{{'card-info__content': true, active: expanded} | tokenList }}">
        <div class="card-info__background"></div>
        <div class="card-info__color-block">
          <div class="card-info__color-block-ripple" style="background: {{rippleColor}};"></div>
        </div>

        <h1 class="card__title">{{cardTitle}}</h1>

        <div class="container">
          <content select=".post-takeover"></content>
        </div>

        <template if="{{photo}}">
          <div class="about-photo" style="background: url({{photo}}) top center no-repeat;"></div>
        </template>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      cardTitle: '',
      expanded: false,
      photo: '',
      rippleColor: '#455A64',

      takeover: function(e) {
        this.expanded = true;
        this.async(function() {
          this.takeover_(e);
        }.bind(this));
      },

      takeover_: function(e) {
        // Grab elements we care about
        var cardContainer = this.shadowRoot.querySelector('#cardContainer');
        var cardContainerContainer = cardContainer.querySelector('.container');
        var cardMetrics = cardContainerContainer.getBoundingClientRect();
        var cardColorBlock = cardContainer.querySelector('.card-info__color-block');
        var cardColorRipple = cardContainer.querySelector(
            '.card-info__color-block-ripple');

        // Figure out where the card is, and what scales we need to apply to our
        // color block to get it to match.
        var currentColorBlockMetrics = cardColorBlock.getBoundingClientRect();
        var scaleX = cardMetrics.width / currentColorBlockMetrics.width;
        var scaleY = cardMetrics.height / currentColorBlockMetrics.height;
        var diameter = Math.max(currentColorBlockMetrics.width,
                currentColorBlockMetrics.height) * 1.3;
        var radius = diameter * 0.5;

        // Adjust for scroll position
        var top = cardMetrics.top + window.scrollY;

        // Set the transform on the color block such that it 100% maps to
        // the card that is expanding.
        cardColorBlock.style.transform = [
          'translate(' + cardMetrics.left + 'px, ' + top + 'px)',
          'scale(' + scaleX + ', ' + scaleY + ')'
        ].join(' ');

        // Set up the ripple inside it.
        cardColorRipple.style.width = diameter + 'px';
        cardColorRipple.style.height = diameter + 'px';

        // Figure out *proportionally* where the user clicked on the card
        // and position the ripple to the same location. It has to be scaled
        // around because we downscaled its parent element (the color block) to
        // match the card... makes this messy.
        var clickX = (e.pageX - cardMetrics.left);
        var clickY = (e.pageY - cardMetrics.top) - window.scrollY;
        var remappedClickX = ((clickX / cardMetrics.width) - 0.5) *
            currentColorBlockMetrics.width;
        var remappedClickY = ((clickY / cardMetrics.height) - 0.5) *
            currentColorBlockMetrics.height;

        var rippleX = 0;
        var rippleY = 0;

        // Set the ripple position.
        cardColorRipple.style.transform = [
          'translate(' + (remappedClickX - radius) + 'px, ' +
          (remappedClickY - radius) + 'px)',
          'scale(0)'
        ].join(' ');

        // Read to force the style changes to apply
        top = cardColorBlock.offsetTop;

        // Switch on animations.
        cardColorBlock.classList.add('card-info__color-block--animatable');
        cardColorRipple.classList.add('card-info__color-block-ripple--animatable');

        // Now transition the color block.
        cardColorBlock.style.transform = [
          'translate(0, 0)',
          'scale(1)'
        ].join(' ');

        // And the ripple.
        cardColorRipple.style.transform = [
          'translate(-' + radius + 'px, -' + radius + 'px)',
          'scale(1, ' + (1 / scaleX) + ')'
        ].join(' ');
      },

      ready: function() {
        var takeoverLink = this.querySelector('.js-card-takeover');
        takeoverLink.addEventListener('click', this.takeover.bind(this));
      }
    });
  </script>
</polymer-element>