{% define "title" %}Attend Offsite{% end %}

{% define "mastheadBgClass" %}bg-cyan{% end %}

{% define "masthead" %}
  <h1><i18n-msg msgid="attend-offsite">Attend Offsite</i18n-msg></h1>
{% end %}

{% define "content" %}
  <core-toolbar class="navbar__overlay navbar__overlay--video" aria-hidden="{{!fullscreenVideoActive}}" fit>
    <paper-icon-button icon="arrow-back" on-tap="{{closeVideoSection}}" aria-label="Close video"></paper-icon-button>
    <span flex><i18n-msg msgid="ioextendedwatch">Watch the 2014 I/O Extended recap video</i18n-msg></span>
  </core-toolbar>

  <core-toolbar class="navbar__overlay navbar__overlay--extended" aria-hidden="{{!fullscreenVideoActive}}" fit>
    <paper-icon-button icon="arrow-back" on-tap="{{closeExtendedMapSection}}" aria-label="Close extended map"></paper-icon-button>
    <span flex>2015 Extended events</span>
  </core-toolbar>

  <template if="{{fullscreenVideoActive}}">
    <div class="fullvideo__container" fit>
     <google-youtube videoid="A-bjrru5bLU" height="100%" width="100%" fit
                     autohide="1" controls="2" modestbranding="1" showinfo="0"
                     iv_load_policy="3" rel="0" autoplay="1"
                     on-google-youtube-ready="{{onVideoReady}}"></google-youtube>
    </div>
  </template>

  <div class="card__container card__container--top slide-up">
    <div class="card js-experiment-visualizer">
      <div class="card-content">
        <!-- <h3 class="card__title"><i18n-msg msgid="livestream">Live stream</i18n-msg></h3> -->
        <h3><i18n-msg msgid="watch-keynote-and-sessions">I/O 2015 will be streamed live. Watch the keynote and select sessions in real time, from your laptop or mobile device. Join an I/O Extended event to watch with other developers and make a party of it.</i18n-msg></h3>
      </div>
    </div>
  </div>
  <div class="slide-up-delay">
    <section class="card__photo--stage page__section js-experiment-instrument" layout vertical center-center>
      <div class="play__button__container" on-tap="{{openSectionVideo}}" data-track-link="offsite-watch-extended-recap-video">
        <h5><i18n-msg msgid="ioextendedwatch">Watch the 2014 I/O Extended recap video</i18n-msg></h5>
      </div>
    </section>

    <div class="card__container sidebyside" layout horizontal vertical?="{{isPhoneSize}}" relative>
      <div class="card js-experiment-visualizer" auto-vertical flex>
        <div class="card-content">
          <h3 class="card__title"><i18n-msg msgid="ioextendevents">I/O Extended events</i18n-msg></h3>
          <div><i18n-msg msgid="ioextendevents-details">I/O Extended events may include live streamed sessions, local developer demos, hackathons and more. These events are brought to you by our Google Developer Groups, Student Ambassadors, and local developers.</i18n-msg></div>
        </div>
      </div>
      <div class="card js-experiment-visualizer" auto-vertical flex>
        <div class="card-content">
          <h3 class="card__title"><i18n-msg msgid="hostioextend">Host an I/O Extended event</i18n-msg></h3>
          <div>We've got you covered with all the information you need to bring I/O to your neighborhood.</div>
        </div>
        <div class="card-content link-spacing">
          <a href="//docs.google.com/presentation/d/1rUwLzz3-Hgcs9eu1uph4En1FUCcpTQspw-xpK4Kaoms/pub?start=true&loop=false&delayms=30000"
             data-track-link="offsite-download-organizers-guide" target="_blank"><i18n-msg msgid="organizerguide">Organizer Guide</i18n-msg></a> <a href="form" data-ajax-link data-track-link="offsite-submit-event"><i18n-msg msgid="submitevent">Submit your event</i18n-msg></a>
        </div>
      </div>
    </div>

    <section class="page__section page__section--attend bg-dark-grey js-experiment-instrument">

      <div class="marker-results">
        <div class="card marker-card">
          <paper-icon-button icon="io:close" class="close-button" on-tap="{{resetExtendedSearch}}"></paper-icon-button>
          <template repeat="{{marker in offsiteMarkerResults}}">
            <div class="card-content">
              <h4 class="card__title">{{marker.name}}</h4>
              <div layout horizontal center justified>
                <span><a href="//www.google.com/maps/place/{{marker.lat}},{{marker.lng}}" target="_blank">View in Google Maps</a></span>
                <a href="{{marker.link}}" data-track-link="offsite-visit-eventpage" target="_blank">Event details</a>
              </div>
            </div>
          </template>
        </div>
      </div>

      <h2 class="extended-title">Find an I/O Extended event near you</h2>

      <div class="action__links" layout vertical>
        <template if="{{extendedMapActive && didExtendedSearch && !offsiteMarkerResults.length}}">
          <h4>There are no events near that location. Try another search or check back later to find new events.</h4>
        </template>

        <!-- <paper-button data-track-link="offsite-notify-me">
          <core-icon icon="io:notifications-none"></core-icon><i18n-msg msgid="notifyme">Notify me about 2015 events near me</i18n-msg>
        </paper-button> -->
        <paper-button class="view__events" on-tap="{{openExtendedMap}}">
          <a href="#" data-track-link="offsite-view-2015-events"><core-icon icon="io:place"></core-icon>Find 2015 events</a>
        </paper-button>
        <div class="search__map" layout horizontal center self-center relative>
          <core-icon icon="io:search"></core-icon>
          <paper-input id="autocomplete" label="Search for a location"></paper-input>
        </div>
      </div>
      <div class="attend__globe {{ {show: offsiteGlobeVisible} | tokenList }}"
           on-marker-click="{{onMarkerClick}}" relative>

        <google-maps-api on-api-load="{{initExtendedSearchBox}}" clientId="google-io" libraries="places" hidden></google-maps-api>

        <webgl-globe id="offsite-globe"
                     markers="{{offsiteLocations}}"
                     locationTarget="{'lat': 36.5, 'lng': 0}"
                     fov="0.3927"
                     offsetY="-0.625"
                     transitionDuration="4000"
                     attractLoop
                     scrollTarget="{{ScrollContainer}}"
                     scrollTriggered="{{offsiteGlobeVisible}}"
                     noInit?="{{!pageTransitionDone}}"
                     noDraw?="{{mode === 'active'}}"></webgl-globe>

        <core-ajax url="api/extended" handleAs="json"
                   auto?="{{pageTransitionDone && !offsiteLocations}}"
                   response="{{offsiteLocations}}"></core-ajax>
      </div>
    </section>
  </div>

  <script>
  (function() {

    var ANIMATION_DURATION = 500;

    function runVideoSectionAnimation(opt_reverse, opt_callback) {
      var topCard = IOWA.Elements.Main.querySelector('.card__container.slide-up');
      var bottomCard = IOWA.Elements.Main.querySelector('.card__photo--stage').nextElementSibling;

      var videoContainer = document.querySelector('.fullvideo__container');
      var video = videoContainer.querySelector('.fullvideo__container google-youtube');

      // Wait for cc module to load, then make the fontsize smaller.
      // https://developers.google.com/youtube/iframe_api_reference#Events
      var callback = function() {
        video.player.setOption('captions', 'fontSize', -2);
        video.player.removeEventListener('onApiChange', callback);
      };
      video.player.addEventListener('onApiChange', callback);

      var animationTiming = {
        duration: ANIMATION_DURATION,
        fill: 'forwards',
        direction: opt_reverse ? 'reverse' : 'normal',
        easing: 'cubic-bezier(0.4,0,0.2,1)'
      };

      var button = IOWA.Elements.Main.querySelector('.play__button__container');

      var animation = new Animation(button, [
        {opacity: 1}, {opacity: 0}
      ], animationTiming);

      // Only animate top/bottom cards offscreen if not on mobile.
      if (!IOWA.Elements.Template.isPhoneSize) {
        animation = new AnimationGroup([
          animation,
          new Animation(topCard, [
            {transform: 'translateY(0)', opacity: 1},
            {transform: 'translateY(-100px)', opacity: 0}
          ], animationTiming),
          new Animation(bottomCard, [
            {transform: 'translateY(0)', opacity: 1},
            {transform: 'translateY(100px)', opacity: 0}
          ], animationTiming)
        ]);
      }

      var videoAnimation = new Animation(video, [
        {opacity: 0}, {opacity: 1}
      ], animationTiming);

      var navOverlay = document.querySelector('.navbar__overlay--video');

      if (opt_reverse) {
        // Fade out gallery and slide back in page sections at the same time.
        IOWA.PageAnimation.play(new AnimationGroup([
          animation, videoAnimation
        ]), opt_callback);
        navOverlay.classList.remove('active');
      } else {
        // Slide out page sections, then fade in gallery.
        IOWA.PageAnimation.play(new AnimationSequence([
          animation, videoAnimation
        ]), opt_callback);
        navOverlay.classList.add('active');
      }
    }

    function runExtendedMapAnimation(opt_reverse, opt_callback) {
      var bottomCard = IOWA.Elements.Main.querySelector('.card__photo--stage').nextElementSibling;
      var viewButton = IOWA.Elements.Main.querySelector('.view__events');
      var searchInput = IOWA.Elements.Main.querySelector('.search__map');
      var sectionTitle = IOWA.Elements.Main.querySelector('.extended-title');

      var animationTiming = {
        duration: ANIMATION_DURATION,
        fill: 'forwards',
        direction: opt_reverse ? 'reverse' : 'normal',
        easing: 'cubic-bezier(0.4,0,0.2,1)'
      };

      var animation = new AnimationGroup([
        new Animation(viewButton, [
          {opacity: 1, visibility: 'visible'},
          {opacity: 0, visibility: 'hidden'}
        ], animationTiming),
        new Animation(sectionTitle, [
          {opacity: 1, visibility: 'visible'},
          {opacity: 0, visibility: 'hidden'}
        ], animationTiming)
      ]);

      // Only animate card offscreen if not on mobile.
      if (!IOWA.Elements.Template.isPhoneSize) {
        animation = new AnimationGroup([
          animation,
          new Animation(bottomCard, [
            {transform: 'translateY(0)', opacity: 1},
            {transform: 'translateY(-100px)', opacity: 0}
          ], animationTiming)
        ]);
      }

      var searchInputAnimation = new Animation(searchInput, [
        {opacity: 0, visibility: 'hidden'},
        {opacity: 1, visibility: 'visible'}
      ], animationTiming);

      var navOverlay = document.querySelector('.navbar__overlay--extended');

      if (opt_reverse) {
        // Fade in button, and bring back cards at same time.
        IOWA.PageAnimation.play(new AnimationGroup([
          animation, searchInputAnimation
        ]), opt_callback);
        navOverlay.classList.remove('active');
      } else {
        // Dismiss cards offscreen, then fade in search input.
        IOWA.PageAnimation.play(new AnimationSequence([
          animation, searchInputAnimation
        ]), opt_callback);
        navOverlay.classList.add('active');
      }
    }

    // Page-specific JS that runs when this page is loaded for the first time.
    function initPage() {
      var page = IOWA.Elements.Template.pages[IOWA.Elements.Template.selectedPage];

      if (page.hasBeenLoaded) {
        return;
      }

      page.load = function() {
        // Reset template variables for when revisiting the page.
        IOWA.Elements.Template.offsiteGlobeVisible = false;
        IOWA.Elements.Template.fullscreenVideoActive = false;
        IOWA.Elements.Template.extendedMapActive = false;
        IOWA.Elements.Template.didExtendedSearch = false;
        IOWA.Elements.Template.offsiteMarkerResults= [];

        // Offsite event search radius in kilometers.
        IOWA.Elements.Template.offsiteSearchRadius = 80;

        if (location.hash.substring(1) === 'join') {
          var onPageTransitionDone_ = function(e) {
            IOWA.Elements.Template.openExtendedMap(800);
            document.removeEventListener('page-transition-done', onPageTransitionDone_);
          };

          document.addEventListener('page-transition-done', onPageTransitionDone_);
        }
      };

      IOWA.Elements.Template.onVideoReady = function(e, detail, sender) {
        runVideoSectionAnimation();
      };

      IOWA.Elements.Template.closeVideoSection = function(e, detail, sender) {
        runVideoSectionAnimation(true, function() {
          IOWA.Elements.Template.fullscreenVideoActive = false;
        });
      };

      IOWA.Elements.Template.openSectionVideo = function(e, detail, sender) {
        IOWA.Analytics.trackEvent('link', 'click', sender.getAttribute('data-track-link'));

        // Only smooth scroll to content if not on mobile.
        if (IOWA.Elements.Template.isPhoneSize) {
          this.fullscreenVideoActive = true; // stamp template
        } else {
          var videoStage = IOWA.Elements.Main.querySelector('.card__photo--stage');
          IOWA.Util.smoothScroll(videoStage, 300, function() {
            this.fullscreenVideoActive = true; // stamp template
          }.bind(this));
        }
      };

      IOWA.Elements.Template.closeExtendedMapSection = function(e, detail, sender) {
        this.scrollLock(false);
        this.resetExtendedSearch();

        runExtendedMapAnimation(true, function() {
          IOWA.Elements.Template.extendedMapActive = false;
          history.replaceState({}, null, location.pathname); // Remove #join hash from URL.
        });
      };

      IOWA.Elements.Template.openExtendedMap = function(e, detail, sender) {
        var scrollDuration = (typeof e === 'number') ? e : 400;

        // Smooth scroll to globe section.
        var destEl = IOWA.Elements.Main.querySelector('.page__section--attend');
        IOWA.Util.smoothScroll(destEl, scrollDuration, function() {
          IOWA.Elements.Template.scrollLock(true);

          IOWA.Elements.Template.extendedMapActive = true;
          IOWA.Elements.Template.offsiteMarkerResults= [];
          runExtendedMapAnimation();
        });
      };

      IOWA.Elements.Template.initExtendedSearchBox = function(e, detail, sender) {
        // Add autocomplete to the extended search box when Maps API has loaded.
        var autocomplete = new google.maps.places.Autocomplete(
            document.querySelector('.page__section--attend #autocomplete'),
            {types: ['geocode']});
        var globe = document.querySelector('#offsite-globe');

        google.maps.event.addListener(autocomplete, 'place_changed', function() {
          var place = autocomplete.getPlace();
          if (!place.geometry) {
            return;
          }

          var location = place.geometry.location;

          // Find all offsite events within a search radius and put in card.
          var nearestMarkers = globe.getMarkersWithinDistance(location.lat(),
              location.lng(), this.offsiteSearchRadius);
          this.offsiteMarkerResults = [];
          for (var i = 0; i < nearestMarkers.length; i++) {
            this.offsiteMarkerResults.push(this.offsiteLocations[nearestMarkers[i].index]);
          }

          globe.location = {
            lat: location.lat(),
            lng: location.lng()
          };

          IOWA.Elements.Template.didExtendedSearch = true;

          IOWA.Elements.Main.querySelector('.marker-results').classList.add('active');

          IOWA.Analytics.trackEvent('globe', 'place select', place.name);
        }.bind(this));
      };

      IOWA.Elements.Template.resetExtendedSearch = function(e, detail, sender) {
        IOWA.Elements.Main.querySelector('.marker-results').classList.remove('active');
        document.querySelector('.page__section--attend #autocomplete').value = null;
        IOWA.Elements.Template.didExtendedSearch = false;
      };

      IOWA.Elements.Template.onMarkerClick = function(e, detail, sender) {
        e.stopPropagation();

        var centerLocation = this.offsiteLocations[e.detail.markerIndex];

        function focusLocation() {
          IOWA.Elements.Main.querySelector('.marker-results').classList.add('active');
          var globe = document.querySelector('#offsite-globe');
          globe.location = {
            lat: centerLocation.lat,
            lng: centerLocation.lng
          };

          // Find all offsite events within a search radius around this marker and put in card.
          var nearestMarkers = globe.getMarkersWithinDistance(
              centerLocation.lat, centerLocation.lng, this.offsiteSearchRadius);
          this.offsiteMarkerResults = [];
          for (var i = 0; i < nearestMarkers.length; i++) {
            this.offsiteMarkerResults.push(this.offsiteLocations[nearestMarkers[i].index]);
          }
        }

        if (!IOWA.Elements.Template.extendedMapActive) {
          this.openExtendedMap(200);
          this.async(focusLocation, null, 400);
        } else {
          focusLocation.call(this);
        }

        IOWA.Analytics.trackEvent('globe', 'marker click');
      };

      page.load(); // Run load callback on page load.
      page.hasBeenLoaded = true;
    }

    // IE will be "loading" at this point. Other browsers will already be "complete".
    if (document.readyState !== 'loading') {
      initPage();
    }

    // Necessary for IE's lack of native <template>
    // https://github.com/GoogleChrome/ioweb2015/issues/599
    window._initPage = initPage;

  })();
  </script>
{% end %}
